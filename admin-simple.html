<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Basit</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto p-8">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h1 class="text-3xl font-bold mb-4">üçΩÔ∏è QR Men√º Admin Panel</h1>
            <button onclick="logout()" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">√áƒ±kƒ±≈ü</button>
        </div>

        <!-- √úr√ºn Ekle Formu -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">‚ûï Yeni √úr√ºn Ekle</h2>
            <form id="product-form" class="space-y-4">
                <div>
                    <label class="block font-bold mb-2">√úr√ºn Adƒ± *</label>
                    <input type="text" id="name" required class="w-full px-4 py-2 border rounded">
                </div>
                
                <div>
                    <label class="block font-bold mb-2">Kategori *</label>
                    <select id="category" required class="w-full px-4 py-2 border rounded">
                        <option value="nargile">Nargile</option>
                        <option value="sicak">Sƒ±cak ƒ∞√ßecekler</option>
                        <option value="soguk">Soƒüuk ƒ∞√ßecekler</option>
                        <option value="yemek">Yemekler</option>
                        <option value="tatli">Tatlƒ±lar</option>
                    </select>
                </div>
                
                <div>
                    <label class="block font-bold mb-2">Fiyat *</label>
                    <input type="text" id="price" required placeholder="√∂rn: 50‚Ç∫" class="w-full px-4 py-2 border rounded">
                </div>
                
                <div>
                    <label class="block font-bold mb-2">A√ßƒ±klama</label>
                    <textarea id="description" rows="3" class="w-full px-4 py-2 border rounded"></textarea>
                </div>
                
                <div>
                    <label class="block font-bold mb-2">Fotoƒüraf (max 2MB)</label>
                    <input type="file" id="image" accept="image/*" class="w-full px-4 py-2 border rounded">
                    <img id="preview" class="hidden mt-2 w-full h-48 object-cover rounded">
                </div>
                
                <button type="submit" class="w-full px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold text-lg">
                    üíæ KAYDET
                </button>
            </form>
        </div>

        <!-- √úr√ºn Listesi -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-2xl font-bold mb-4">üì¶ √úr√ºnler (<span id="product-count">0</span>)</h2>
            <button onclick="refreshProducts()" class="mb-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                üîÑ Yenile
            </button>
            <div id="products-list" class="space-y-4"></div>
        </div>
    </div>

    <script src="local-database.js"></script>
    <script>
        // Giri≈ü kontrol√º
        const loginData = JSON.parse(localStorage.getItem('adminLogin')) || JSON.parse(sessionStorage.getItem('adminLogin'));
        if (!loginData || !loginData.isLoggedIn) {
            window.location.href = 'login.html';
        }

        function logout() {
            if (confirm('√áƒ±kƒ±≈ü yapmak istediƒüinizden emin misiniz?')) {
                localStorage.removeItem('adminLogin');
                sessionStorage.removeItem('adminLogin');
                window.location.href = 'login.html';
            }
        }

        // LocalDB'yi ba≈ülat
        LocalDB.initialize();

        // Fotoƒüraf √∂nizleme
        document.getElementById('image').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            if (file.size > 2 * 1024 * 1024) {
                alert('Fotoƒüraf 2MB\'dan k√º√ß√ºk olmalƒ±!');
                e.target.value = '';
                return;
            }

            try {
                const base64 = await LocalDB.image.toBase64(file);
                const optimized = await LocalDB.image.optimize(base64, 800, 600, 0.8);
                document.getElementById('preview').src = optimized;
                document.getElementById('preview').classList.remove('hidden');
            } catch (error) {
                alert('Fotoƒüraf y√ºklenemedi: ' + error.message);
            }
        });

        // Form submit
        document.getElementById('product-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const imageFile = document.getElementById('image').files[0];
            let imageData = '';

            if (imageFile) {
                try {
                    const base64 = await LocalDB.image.toBase64(imageFile);
                    imageData = await LocalDB.image.optimize(base64, 800, 600, 0.8);
                } catch (error) {
                    alert('Fotoƒüraf i≈ülenemedi: ' + error.message);
                    return;
                }
            }

            const product = {
                id: Date.now(),
                name: document.getElementById('name').value,
                category: document.getElementById('category').value,
                price: document.getElementById('price').value,
                description: document.getElementById('description').value,
                image: imageData,
                details: {}
            };

            console.log('√úr√ºn ekleniyor:', product.name);

            // Mevcut √ºr√ºnleri al
            const products = LocalDB.menu.getAll();
            products.push(product);

            // Kaydet
            const saved = LocalDB.menu.saveAll(products);

            if (saved) {
                alert('‚úÖ √úr√ºn eklendi: ' + product.name);
                document.getElementById('product-form').reset();
                document.getElementById('preview').classList.add('hidden');
                refreshProducts();
            } else {
                alert('‚ùå √úr√ºn eklenemedi!');
            }
        });

        // √úr√ºnleri listele
        function refreshProducts() {
            console.log('√úr√ºnler yenileniyor...');
            
            const products = LocalDB.menu.getAll();
            console.log('Toplam √ºr√ºn:', products.length);
            
            document.getElementById('product-count').textContent = products.length;
            
            const list = document.getElementById('products-list');
            
            if (products.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center py-8">Hen√ºz √ºr√ºn yok</p>';
                return;
            }

            list.innerHTML = products.map(p => `
                <div class="border rounded-lg p-4 flex items-center gap-4">
                    ${p.image ? `<img src="${p.image}" class="w-24 h-24 object-cover rounded">` : '<div class="w-24 h-24 bg-gray-200 rounded flex items-center justify-center text-gray-400">Fotoƒüraf Yok</div>'}
                    <div class="flex-1">
                        <h3 class="font-bold text-lg">${p.name}</h3>
                        <p class="text-gray-600">${p.category} - ${p.price}</p>
                        <p class="text-sm text-gray-500">${p.description || ''}</p>
                    </div>
                    <button onclick="deleteProduct(${p.id})" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                        Sil
                    </button>
                </div>
            `).join('');
        }

        // √úr√ºn sil
        function deleteProduct(id) {
            if (!confirm('Bu √ºr√ºn√º silmek istediƒüinizden emin misiniz?')) return;

            const products = LocalDB.menu.getAll();
            const filtered = products.filter(p => p.id !== id);
            
            const saved = LocalDB.menu.saveAll(filtered);
            
            if (saved) {
                alert('‚úÖ √úr√ºn silindi!');
                refreshProducts();
            } else {
                alert('‚ùå √úr√ºn silinemedi!');
            }
        }

        // JSON'a aktar VE otomatik senkronize et
        async function exportToJSON() {
            const products = LocalDB.menu.getAll();
            const categories = LocalDB.categories.getAll();
            const settings = LocalDB.settings.get();

            const data = {
                settings: settings,
                categories: categories,
                products: products,
                lastUpdate: new Date().toISOString()
            };

            // 1. JSON dosyasƒ±nƒ± indir (yedek i√ßin)
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'menu-data.json';
            a.click();
            URL.revokeObjectURL(url);

            // 2. Otomatik senkronizasyon i√ßin localStorage'a kaydet
            localStorage.setItem('qr_menu_cloud_data', json);
            
            alert('‚úÖ Men√º kaydedildi!\n\nüì• menu-data.json dosyasƒ± indirildi (yedek i√ßin)\nüîÑ Veriler otomatik senkronize edildi\n\nüí° T√ºm cihazlar artƒ±k g√ºncel men√ºy√º g√∂recek!');
        }

        // Otomatik senkronizasyon butonu ekle
        function addSyncButton() {
            const container = document.querySelector('.bg-white.rounded-lg.shadow-lg.p-6.mb-6');
            const syncBtn = document.createElement('button');
            syncBtn.onclick = exportToJSON;
            syncBtn.className = 'ml-2 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700';
            syncBtn.innerHTML = 'üì• JSON\'a Aktar & Senkronize Et';
            container.appendChild(syncBtn);
        }

        // Sayfa y√ºklendiƒüinde √ºr√ºnleri g√∂ster ve senkronizasyon butonunu ekle
        window.addEventListener('load', () => {
            refreshProducts();
            addSyncButton();
        });
    </script>
</body>
</html>
