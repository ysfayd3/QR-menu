<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leanor Cafe - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Veritabanƒ± ve Ara√ßlar -->
    <script src="local-database.js"></script>
    <script src="photo-storage.js"></script>
    <script src="sync-config.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        * { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside class="w-64 bg-gradient-to-b from-slate-900 to-slate-800 text-white flex-shrink-0 hidden md:block">
            <div class="p-6">
                <div class="flex items-center gap-3 mb-8">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="font-bold text-lg">Leanor Cafe</h1>
                        <p class="text-xs text-slate-400">Admin Panel</p>
                    </div>
                </div>
                
                <nav class="space-y-2" id="sidebar-nav">
                    <!-- Nav items will be inserted by admin-modern.js -->
                </nav>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Header -->
            <header class="bg-white border-b border-gray-200 px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <button class="md:hidden" onclick="document.querySelector('aside').classList.toggle('hidden')">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                            </svg>
                        </button>
                        <h2 class="text-2xl font-bold text-gray-800" id="page-title">√úr√ºnler</h2>
                    </div>
                    
                    <div class="flex items-center gap-3">
                        <button onclick="showSyncSettings()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm font-medium flex items-center gap-2">
                            <span>‚öôÔ∏è</span> <span class="hidden sm:inline">Senkronizasyon</span>
                        </button>
                        <button onclick="manualSync()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition text-sm font-medium flex items-center gap-2">
                            <span>üåê</span> <span class="hidden sm:inline">G√ºncelle</span>
                        </button>
                        <a href="index.html" target="_blank" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm font-medium flex items-center gap-2">
                            <span>üì±</span> <span class="hidden sm:inline">Men√ºy√º G√∂r</span>
                        </a>
                        <span class="hidden sm:flex items-center gap-2 px-3 py-2 bg-gray-100 rounded-lg text-sm">
                            <span class="font-medium text-gray-700" id="username-display">Admin</span>
                        </span>
                        <button onclick="logout()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition text-sm font-medium">
                            √áƒ±kƒ±≈ü
                        </button>
                    </div>
                </div>
            </header>

            <!-- Content Area -->
            <main class="flex-1 overflow-y-auto p-6">
                <div id="content-area">
                    <!-- Content will be loaded here by admin-modern.js -->
                </div>
            </main>
        </div>
    </div>

    <!-- Modals Container -->
    <div id="modals-container"></div>

    <!-- Sync Modal (Hidden) -->
    <div id="sync-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-2xl w-full mx-4">
            <h2 class="text-2xl font-bold mb-4">‚öôÔ∏è Otomatik Senkronizasyon Ayarlarƒ±</h2>
            
            <div class="space-y-4 mb-6">
                <div>
                    <label class="block font-bold mb-2">Senkronizasyon Y√∂ntemi</label>
                    <select id="sync-method" class="w-full px-4 py-2 border rounded" onchange="updateSyncMethod()">
                        <option value="">Kapalƒ± (Manuel)</option>
                        <option value="gist">GitHub Gist (√ñnerilen)</option>
                        <option value="jsonbin">JSONBin.io</option>
                        <option value="custom">√ñzel URL</option>
                    </select>
                </div>

                <!-- GitHub Gist Ayarlarƒ± -->
                <div id="gist-settings" class="hidden space-y-4">
                    <div>
                        <label class="block font-bold mb-2">GitHub Personal Access Token</label>
                        <input type="password" id="gist-token" placeholder="ghp_xxxxxxxxxxxx" class="w-full px-4 py-2 border rounded">
                        <p class="text-sm text-gray-600 mt-1">
                            <a href="https://github.com/settings/tokens/new" target="_blank" class="text-blue-600 hover:underline">
                                Token olu≈ütur ‚Üí
                            </a> (Sadece "gist" yetkisi se√ß)
                        </p>
                    </div>
                    <div>
                        <label class="block font-bold mb-2">Gist ID (Opsiyonel - Bo≈ü bƒ±rakƒ±rsan otomatik olu≈üturulur)</label>
                        <input type="text" id="gist-id" placeholder="abc123def456" class="w-full px-4 py-2 border rounded">
                    </div>
                </div>

                <!-- JSONBin Ayarlarƒ± -->
                <div id="jsonbin-settings" class="hidden space-y-4">
                    <div>
                        <label class="block font-bold mb-2">JSONBin API Key</label>
                        <input type="password" id="jsonbin-key" placeholder="$2a$10$..." class="w-full px-4 py-2 border rounded">
                        <p class="text-sm text-gray-600 mt-1">
                            <a href="https://jsonbin.io/api-keys" target="_blank" class="text-blue-600 hover:underline">
                                API Key al ‚Üí
                            </a>
                        </p>
                    </div>
                    <div>
                        <label class="block font-bold mb-2">Bin ID (Opsiyonel)</label>
                        <input type="text" id="jsonbin-id" placeholder="65abc123def456" class="w-full px-4 py-2 border rounded">
                    </div>
                </div>

                <!-- √ñzel URL Ayarlarƒ± -->
                <div id="custom-settings" class="hidden space-y-4">
                    <div>
                        <label class="block font-bold mb-2">API Endpoint URL</label>
                        <input type="url" id="custom-url" placeholder="https://siteniz.com/api/menu" class="w-full px-4 py-2 border rounded">
                    </div>
                </div>
            </div>

            <div class="flex gap-2">
                <button onclick="saveSyncSettings()" class="flex-1 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold">
                    üíæ Kaydet
                </button>
                <button onclick="testSync()" class="flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold">
                    üß™ Test Et
                </button>
                <button onclick="closeSyncModal()" class="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 font-bold">
                    ƒ∞ptal
                </button>
            </div>

            <div id="sync-status" class="mt-4 p-4 rounded hidden"></div>
        </div>
    </div>

    <script>
        // Giri≈ü kontrol√º
        const loginData = JSON.parse(localStorage.getItem('adminLogin')) || JSON.parse(sessionStorage.getItem('adminLogin'));
        if (!loginData || !loginData.isLoggedIn) {
            window.location.href = 'login.html';
        }

        function logout() {
            if (confirm('√áƒ±kƒ±≈ü yapmak istediƒüinizden emin misiniz?')) {
                localStorage.removeItem('adminLogin');
                sessionStorage.removeItem('adminLogin');
                window.location.href = 'login.html';
            }
        }

        // Senkronizasyon ayarlarƒ±nƒ± y√ºkle
        function loadSyncSettings() {
            const settings = JSON.parse(localStorage.getItem('qr_menu_sync_settings') || '{}');
            return settings;
        }

        // Senkronizasyon ayarlarƒ±nƒ± kaydet
        function saveSyncSettingsToStorage(settings) {
            localStorage.setItem('qr_menu_sync_settings', JSON.stringify(settings));
        }

        // Senkronizasyon modal
        function showSyncSettings() {
            const settings = loadSyncSettings();
            document.getElementById('sync-method').value = settings.method || '';
            
            if (settings.method === 'gist') {
                document.getElementById('gist-token').value = settings.gistToken || '';
                document.getElementById('gist-id').value = settings.gistId || '';
            } else if (settings.method === 'jsonbin') {
                document.getElementById('jsonbin-key').value = settings.jsonbinKey || '';
                document.getElementById('jsonbin-id').value = settings.jsonbinId || '';
            } else if (settings.method === 'custom') {
                document.getElementById('custom-url').value = settings.customUrl || '';
            }
            
            updateSyncMethod();
            document.getElementById('sync-modal').classList.remove('hidden');
        }

        function closeSyncModal() {
            document.getElementById('sync-modal').classList.add('hidden');
        }

        function updateSyncMethod() {
            const method = document.getElementById('sync-method').value;
            
            document.getElementById('gist-settings').classList.add('hidden');
            document.getElementById('jsonbin-settings').classList.add('hidden');
            document.getElementById('custom-settings').classList.add('hidden');
            
            if (method === 'gist') {
                document.getElementById('gist-settings').classList.remove('hidden');
            } else if (method === 'jsonbin') {
                document.getElementById('jsonbin-settings').classList.remove('hidden');
            } else if (method === 'custom') {
                document.getElementById('custom-settings').classList.remove('hidden');
            }
        }

        function saveSyncSettings() {
            const method = document.getElementById('sync-method').value;
            const settings = { method };
            
            if (method === 'gist') {
                settings.gistToken = document.getElementById('gist-token').value;
                settings.gistId = document.getElementById('gist-id').value;
            } else if (method === 'jsonbin') {
                settings.jsonbinKey = document.getElementById('jsonbin-key').value;
                settings.jsonbinId = document.getElementById('jsonbin-id').value;
            } else if (method === 'custom') {
                settings.customUrl = document.getElementById('custom-url').value;
            }
            
            saveSyncSettingsToStorage(settings);
            showSyncStatus('‚úÖ Ayarlar kaydedildi!', 'success');
            
            setTimeout(() => {
                closeSyncModal();
            }, 1500);
        }

        async function testSync() {
            showSyncStatus('üß™ Test ediliyor...', 'info');
            
            const testData = {
                settings: { cafeName: "Test Cafe", tagline: "Test" },
                categories: [],
                products: [],
                lastUpdate: new Date().toISOString()
            };
            
            const result = await syncToCloud(testData);
            
            if (result.success) {
                showSyncStatus('‚úÖ Test ba≈üarƒ±lƒ±! Senkronizasyon √ßalƒ±≈üƒ±yor.', 'success');
            } else {
                showSyncStatus('‚ùå Test ba≈üarƒ±sƒ±z: ' + result.error, 'error');
            }
        }

        function showSyncStatus(message, type) {
            const status = document.getElementById('sync-status');
            status.textContent = message;
            status.classList.remove('hidden', 'bg-green-100', 'bg-red-100', 'bg-blue-100', 'text-green-800', 'text-red-800', 'text-blue-800');
            
            if (type === 'success') {
                status.classList.add('bg-green-100', 'text-green-800');
            } else if (type === 'error') {
                status.classList.add('bg-red-100', 'text-red-800');
            } else {
                status.classList.add('bg-blue-100', 'text-blue-800');
            }
        }

        // Cloud'a senkronize et
        async function syncToCloud(data) {
            const settings = loadSyncSettings();
            
            if (!settings.method) {
                return { success: false, error: 'Senkronizasyon ayarlanmamƒ±≈ü' };
            }
            
            try {
                if (settings.method === 'gist') {
                    return await syncToGist(data, settings);
                } else if (settings.method === 'jsonbin') {
                    return await syncToJSONBin(data, settings);
                } else if (settings.method === 'custom') {
                    return await syncToCustom(data, settings);
                }
            } catch (error) {
                console.error('Senkronizasyon hatasƒ±:', error);
                return { success: false, error: error.message };
            }
        }

        // GitHub Gist'e y√ºkle
        async function syncToGist(data, settings) {
            const token = settings.gistToken;
            const gistId = settings.gistId;
            
            if (!token) {
                return { success: false, error: 'GitHub token eksik' };
            }
            
            const gistData = {
                description: 'QR Menu Data - Auto Sync',
                public: true,
                files: {
                    'menu-data.json': {
                        content: JSON.stringify(data, null, 2)
                    }
                }
            };
            
            const url = gistId 
                ? `https://api.github.com/gists/${gistId}`
                : 'https://api.github.com/gists';
            
            const method = gistId ? 'PATCH' : 'POST';
            
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Authorization': `token ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(gistData)
            });
            
            if (!response.ok) {
                const error = await response.json();
                return { success: false, error: error.message || 'GitHub API hatasƒ±' };
            }
            
            const result = await response.json();
            
            // Kalƒ±cƒ± URL olu≈ütur (commit hash olmadan)
            const username = result.owner ? result.owner.login : 'raw';
            const permanentUrl = `https://gist.githubusercontent.com/${username}/${result.id}/raw/menu-data.json`;
            
            // Yeni gist olu≈üturulduysa ID'yi kaydet
            if (!gistId) {
                settings.gistId = result.id;
                saveSyncSettingsToStorage(settings);
                alert('‚úÖ Gist olu≈üturuldu!\n\nL√ºtfen sync-config.js dosyasƒ±na ≈üu URL\'yi yapƒ±≈ütƒ±rƒ±n (Sadece bir kez):\n\n' + permanentUrl);
                console.log('‚úÖ Yeni Gist olu≈üturuldu:', result.id);
                console.log('üìã Permanent URL:', permanentUrl);
            }
            
            return { 
                success: true, 
                url: permanentUrl,
                gistId: result.id,
                isNew: !gistId
            };
        }

        // JSONBin'e y√ºkle
        async function syncToJSONBin(data, settings) {
            const apiKey = settings.jsonbinKey;
            const binId = settings.jsonbinId;
            
            if (!apiKey) {
                return { success: false, error: 'JSONBin API key eksik' };
            }
            
            const url = binId
                ? `https://api.jsonbin.io/v3/b/${binId}`
                : 'https://api.jsonbin.io/v3/b';
            
            const method = binId ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-Master-Key': apiKey
                },
                body: JSON.stringify(data)
            });
            
            if (!response.ok) {
                return { success: false, error: 'JSONBin API hatasƒ±' };
            }
            
            const result = await response.json();
            
            // Yeni bin olu≈üturulduysa ID'yi kaydet
            if (!binId && result.metadata) {
                settings.jsonbinId = result.metadata.id;
                saveSyncSettingsToStorage(settings);
                alert('‚úÖ Bin olu≈üturuldu!\n\nL√ºtfen sync-config.js dosyasƒ±na ≈üu URL\'yi yapƒ±≈ütƒ±rƒ±n:\n\nhttps://api.jsonbin.io/v3/b/' + result.metadata.id + '/latest');
                console.log('‚úÖ Yeni Bin olu≈üturuldu:', result.metadata.id);
            }
            
            return { success: true, binId: result.metadata?.id };
        }

        // √ñzel URL'e y√ºkle
        async function syncToCustom(data, settings) {
            const url = settings.customUrl;
            
            if (!url) {
                return { success: false, error: 'URL eksik' };
            }
            
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            
            if (!response.ok) {
                return { success: false, error: 'API hatasƒ±' };
            }
            
            return { success: true };
        }

        // Manuel senkronizasyon
        async function manualSync() {
            const products = LocalDB.menu.getAll();
            const categories = LocalDB.categories.getAll();
            const settings = LocalDB.settings.get();

            const data = {
                settings: settings,
                categories: categories,
                products: products,
                lastUpdate: new Date().toISOString()
            };

            const result = await syncToCloud(data);
            
            if (result.success) {
                let msg = '‚úÖ Men√º ba≈üarƒ±yla senkronize edildi!\n\nüåê T√ºm cihazlar g√ºncellenecek.';
                
                // URL'yi her zaman g√∂ster ki kontrol edilebilsin
                msg += '\n\nüîó ≈ûU AN G√úNCELLENEN ADRES:\n' + result.url + '\n\n(Bu adresin sync-config.js dosyasƒ±ndaki ile AYNI olduƒüundan emin olun)';
                
                alert(msg);
                console.log('üîó G√úNCEL URL:', result.url);
            } else {
                alert('‚ùå Senkronizasyon ba≈üarƒ±sƒ±z!\n\n' + result.error + '\n\nL√ºtfen ayarlarƒ± kontrol edin.');
            }
        }

        // Otomatik senkronizasyon tetikle
        window.triggerAutoSync = async function() {
            const products = LocalDB.menu.getAll();
            const categories = LocalDB.categories.getAll();
            const settings = LocalDB.settings.get();
            const data = {
                settings: settings,
                categories: categories,
                products: products,
                lastUpdate: new Date().toISOString()
            };
            
            // K√º√ß√ºk bildirim g√∂ster
            const notification = document.createElement('div');
            notification.className = 'fixed bottom-4 right-4 bg-blue-600 text-white px-4 py-2 rounded shadow-lg z-50 transition-all duration-300 transform translate-y-0';
            notification.textContent = 'üîÑ Senkronize ediliyor...';
            document.body.appendChild(notification);
            
            const result = await syncToCloud(data);
            
            if (result.success) {
                notification.textContent = '‚úÖ Senkronize edildi';
                notification.className = 'fixed bottom-4 right-4 bg-green-600 text-white px-4 py-2 rounded shadow-lg z-50 transition-all duration-300';
            } else {
                notification.textContent = '‚ö†Ô∏è Senkronizasyon hatasƒ±';
                notification.className = 'fixed bottom-4 right-4 bg-red-600 text-white px-4 py-2 rounded shadow-lg z-50 transition-all duration-300';
            }
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        };
    </script>
    
    <script src="admin-modern.js"></script>
</body>
</html>
